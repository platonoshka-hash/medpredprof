<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>{{ title or site_name or "MedPredProf" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
  <link rel="icon" href="{{ url_for('static', filename='uploads/сеч.png') }}?v=4" type="image/png" sizes="16x16">
  <link rel="icon" href="{{ url_for('static', filename='uploads/сеч.png') }}?v=4" type="image/png" sizes="32x32">
  <link rel="shortcut icon" href="{{ url_for('static', filename='uploads/сеч.png') }}?v=4" type="image/png">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='uploads/сеч.png') }}?v=4">
</head>
<body>
  <header class="container">
    <nav class="nav">
      <a class="brand" href="{{ url_for('index') }}">MedPredProf</a>
      <div class="spacer"></div>
      {% if session.get('is_admin') %}
        <a href="{{ url_for('admin_dashboard') }}">Админ</a>
        <a href="{{ url_for('admin_users') }}">Пользователи</a>
        <a href="{{ url_for('admin_new_theory_form') }}">Добавить теорию</a>
        <a href="{{ url_for('admin_logout') }}">Выход</a>
      {% elif session.get('user_id') %}
        <a href="{{ url_for('theory_list') }}">Теория</a>
        <a href="{{ url_for('logout') }}">Выход</a>
      {% else %}
        <a href="{{ url_for('login_form') }}">Вход</a>
        <a href="{{ url_for('register_form') }}">Регистрация</a>
        <a href="{{ url_for('admin_login_form') }}">Админ</a>
      {% endif %}
    </nav>
  </header>
  <main class="container">
    {% block content %}{% endblock %}
  </main>
  
  {% if session.get('user_id') or session.get('is_admin') %}
  <div class="chat-container">
    <div class="chat-header">
      <h3>Чат</h3>
      <button class="chat-toggle" onclick="toggleChat()">−</button>
    </div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input">
      <input type="text" id="chat-input" placeholder="Введите сообщение..." maxlength="200">
      <button onclick="sendMessage()">Отправить</button>
    </div>
  </div>
  {% endif %}
  
  <footer class="container footer">
    <small>MedPredProf</small>
  </footer>
  
  <script>
    function toggleChat() {
      const chat = document.querySelector('.chat-container');
      const toggle = document.querySelector('.chat-toggle');
      if (chat.classList.contains('collapsed')) {
        chat.classList.remove('collapsed');
        toggle.textContent = '−';
      } else {
        chat.classList.add('collapsed');
        toggle.textContent = '+';
      }
    }
    
    function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;
      
      fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: message})
      }).then(() => {
        input.value = '';
        loadMessages();
      });
    }
    
    function isAdmin() {
      return {{ 'true' if session.get('is_admin') else 'false' }};
    }

    function formatMessageTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      
      if (messageDate.getTime() === today.getTime()) {
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      } else if (messageDate.getTime() === today.getTime() - 24*60*60*1000) {
        return 'Вчера ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      } else {
        return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: '2-digit' }) + 
               ' ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      }
    }

    function formatDateHeader(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      
      if (messageDate.getTime() === today.getTime()) {
        return 'Сегодня';
      } else if (messageDate.getTime() === today.getTime() - 24*60*60*1000) {
        return 'Вчера';
      } else {
        return date.toLocaleDateString('ru-RU', { 
          weekday: 'long', 
          day: 'numeric', 
          month: 'long', 
          year: 'numeric' 
        });
      }
    }

    function loadMessages() {
      fetch('/api/chat')
        .then(r => r.json())
        .then(messages => {
          const container = document.getElementById('chat-messages');
          let lastDate = null;
          let html = '';
          
          messages.reverse().forEach(msg => {
            const messageDate = new Date(msg.created_at).toDateString();
            if (lastDate !== messageDate) {
              html += `<div class="date-header">${formatDateHeader(msg.created_at)}</div>`;
              lastDate = messageDate;
            }
            
            const time = formatMessageTime(msg.created_at);
            const edited = msg.edited_at ? ' (ред.)' : '';
            const currentUserId = {{ session.get('user_id') or 'null' }};
            const isOwner = msg.user_id === currentUserId;
            const canEdit = isOwner || isAdmin();
            
            const editBtn = canEdit ? `<button class="edit-btn" data-id="${msg.id}" data-message="${msg.message.replace(/"/g, '&quot;')}">✏️</button>` : '';
            const delBtn = canEdit ? `<button class="delete-btn" data-id="${msg.id}">🗑️</button>` : '';
            
            html += `
              <div class="message" data-id="${msg.id}">
                <div class="message-content">
                  <div class="message-header">
                    <strong>${msg.full_name} (${msg.class_name})</strong>
                    <span class="message-time">${time}${edited}</span>
                  </div>
                  <div class="message-text">${msg.message}</div>
                </div>
                <div class="message-actions">
                  ${editBtn}
                  ${delBtn}
                </div>
              </div>
            `;
          });
          
          container.innerHTML = html;
          
          // Add event listeners
          container.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const id = e.currentTarget.getAttribute('data-id');
              if (confirm('Удалить сообщение?')) {
                fetch(`/api/chat/${id}`, { method: 'DELETE' })
                  .then(r => r.json())
                  .then(data => {
                    if (data.success) loadMessages();
                    else alert('Ошибка при удалении сообщения');
                  });
              }
            });
          });
          
          container.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const id = e.currentTarget.getAttribute('data-id');
              const currentMessage = e.currentTarget.getAttribute('data-message');
              const newMessage = prompt('Редактировать сообщение:', currentMessage);
              if (newMessage && newMessage.trim() && newMessage !== currentMessage) {
                fetch(`/api/chat/${id}`, { 
                  method: 'PUT',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({message: newMessage.trim()})
                })
                .then(r => r.json())
                .then(data => {
                  if (data.success) loadMessages();
                  else alert('Ошибка при редактировании сообщения');
                });
              }
            });
          });
          
          container.scrollTop = container.scrollHeight;
        });
    }
    
    document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    {% if session.get('user_id') or session.get('is_admin') %}
    loadMessages();
    setInterval(loadMessages, 3000);
    {% endif %}
  </script>
</body>
</html>
